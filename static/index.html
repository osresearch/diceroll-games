<!DOCTYPE html>
<html>
<head>
<title>Chat room demo</title>

<!-- HTML Meta Tags -->
<meta name="description" content="Multi-party chat demo">

<!-- Facebook Meta Tags -->
<meta property="og:url" content="https://echo.v.st/">
<meta property="og:type" content="website">
<meta property="og:title" content="Multi-party chat demo">
<meta property="og:description" content="Websocket based chat room demo">
<meta property="og:image" content="https://echo.v.st/header.jpg">

<!-- Twitter Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:domain" content="echo.v.st">
<meta property="twitter:url" content="https://echo.v.st/">
<meta name="twitter:title" content="Multi-party chat demo">
<meta name="twitter:description" content="Websocket based chat room demo">
<meta name="twitter:image" content="https://echo.v.st/header.jpg">


  <script src="https://cdn.socket.io/4.4.0/socket.io.min.js" integrity="sha384-1fOn6VtTq3PWwfsOrk45LnYcGosJwzMHv+Xh/Jx5303FVOXzEnw0EpLv30mtjmlj" crossorigin="anonymous"></script>

<style>
body  {
	background: black;
	color: #00ff00;
	font: fixed;
}

.private-message {
	color: red;
}

.server-message {
	color: blue;
}

</style>
</head>
<body>
<div id="log"></div>
    <form id="form" action="">
      <input id="input" autocomplete="off" /><button>Send</button>
    </form>
</body>
<script>
const server = document.location.origin;
const sock = io.connect(server);

let form = document.getElementById('form');
let input = document.getElementById('input');

form.addEventListener('submit', function(e) {
	e.preventDefault();
	let msg = input.value;
	if (!msg)
		return;
	if (msg[0] == '@')
	{
		// todo: private message
	}

	sock.emit('message', msg);
	input.value = '';
});

function log_append(src, msg, msg_class="message")
{
	const log = document.getElementById("log");
	const e = document.createElement('p');
	const s = document.createElement('span');
	s.classList.add("sender");
	s.innerText = src;
	e.appendChild(s);

	e.appendChild(document.createTextNode(" "));

	const m = document.createElement('span');
	m.classList.add(msg_class);
	m.innerText = msg;

	e.appendChild(m);
	log.appendChild(e);
}

// called when a connection to the server is established
sock.on('connect', () => {
	// join the room in the URL
	console.log("RECONNECTED");
	log_append(server, 'Reconnected', 'server-message');
	sock.emit('room', 'demo');
});

// server sends this message when a new room is joined
// to inform us of the other members
sock.on('members', (room, members) => {
	console.log(room + " members", members);
	log_append(server, 'members=' + members, 'server-message');
});

// called when a new peer joins the room
sock.on('connected', (id) => {
	console.log(id, "new room member");
	log_append(id, 'JOINED', 'server-message');
});

// called when a peer leaves the room
sock.on('disconnected', (id) => {
	console.log(id, "room member left");
	log_append(id, 'LEFT', 'server-message');
});

// called if a peer sends a message to us
sock.on('direct', (id,msg) => {
	console.log(id, "direct message", msg);
	log_append(id, msg, 'private-message');
});

sock.on('message', (id,msg) => {
	console.log(id, "public message", msg);
	log_append(id, msg, 'message');
});

</script>
</html>
